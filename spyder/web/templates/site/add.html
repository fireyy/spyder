{% extends "layout.html" %}

{% block title %}添加站点{% endblock %}
{% set current_page="site" %}
{% set current_action="site_add" %}

{% block body %}
<div class="container typecho-page-main typecho-post-option typecho-post-area">
  <form action="." method="post" name="add_site">
    <div class="column-18 suffix" id="test">
      <div class="column-18">
        <label for="seed_name" class="typecho-label">名称</label>
        <p><input type="text" id="name" name="name" value="{{ site.name }}" class="text" /></p>
        <label for="base_url" class="typecho-label">网站地址</label>
        <p><input type="text" id="url" name="url" value="{{ site.url }}" class="text" /></p>
        <label for="base_url" class="typecho-label">图片服务器地址</label>
        <p><input type="text" id="staticUrl" name="staticUrl" value="{{ site.sync_profile.staticUrl|default('',true) }}" class="text" /></p>
        <label for="" class="typecho-label">备注</label>
        <p><textarea style="width:700px;height: 200px" autocomplete="off" name="descript">{{ site.descript }}</textarea></p>
        {% if site.id %}<p>
          <label for="seed_name" class="typecho-label">已配置入库规则</label>
          <select class="typecho-charset" name="type" id="type">
            {% for type1 in types %}
            <option value="{{ type1 }}">{{ type1 }}</option>
            {% endfor %}
          </select> 
          <a href="javascript:;" id="add_seed">配置入库规则</a>
        </p>{% endif %}
        <p class="submit">
          <span class="right">
            <input type="hidden" name="do" value="publish" />
            <button type="submit" id="btn-submit">保存站点 &raquo;</button>
          </span>
        </p>
      </div>
    </div>
    <div class="column-06">
      <ul class="typecho-post-option">
        <li>
          <label for="sync_type" class="typecho-label">入库方式</label>
          <p>
            <select class="typecho-charset" name="sync_type" id="sync_type">
              <option value="mysql">MySQL数据库</option>
              <option value="api">API接口</option>
            </select>
          </p>
          <p class="description">请选择采集数据入库的方式</p>
        </li>
        <li id="mysql_form">
          <label for="" class="typecho-label">MySQL配置</label>
          <p>服务器：<input type="text" id="mysql_server" name="mysql_server" value="{{ site.sync_profile.mysql_server|default('',true) }}" size="20" /></p>
          <p>数据库：<input type="text" id="mysql_dbname" name="mysql_dbname" value="{{ site.sync_profile.mysql_dbname|default('',true) }}" size="20" /></p>
          <p>表前缀：<input type="text" id="mysql_prefix" name="mysql_prefix" value="{{ site.sync_profile.mysql_prefix|default('',true) }}" size="20" /></p>
          <p>用户名：<input type="text" id="mysql_username" name="mysql_username" value="{{ site.sync_profile.mysql_username|default('',true) }}" size="20" /></p>
          <p>密&nbsp;&nbsp;&nbsp;码：<input type="text" id="mysql_password" name="mysql_password" value="{{ site.sync_profile.mysql_password|default('',true) }}" size="20" /></p>
          <p class="description">设定MySQL数据库的基本配置 <input type="button" id="test_mysql" value="测试连接"></p>
        </li>
        <li>
          <label for="api_url" class="typecho-label">API接口地址</label>
          <p><input type="text" id="api_url" name="api_url" value="{{ site.sync_profile.api_url|default('',true) }}" class="mini" /></p>
          <p class="description">采用API方式入库请设定接口地址</p>
        </li>
      </ul>
    </div>
  </form>
</div>
<script type="text/javascript">
(function(){
  function testMysql(){
    new Request({
      "url": "{{ url_for('site.test_mysql') }}",
      "data": $('mysql_form').toQueryString(),
      "onRequest": function(){
        $("test_mysql").set("value","正在连接中...").set("disabled", true);
      },
      "onComplete": function(){
        $("test_mysql").set("value","测试连接").erase("disabled");
      },
      "onSuccess": function(t,x){
        if(t=="1"){
          alert("数据库连接成功！")
        }else{
          alert("数据库连接失败！")
        }
      }
    }).send();
  }
  function addSeed(){
    var type = $("type").get("value");
    openWin('/site_map/add/?type='+type+"&site_id={{ site.id }}");
  }
  window.addEvent('domready', function() {
    $("add_seed").addEvent("click", addSeed);
    $("test_mysql").addEvent("click", testMysql);
  })
})();
</script>
{% endblock %}